class ZCL_AOT_SERVICE_REST definition
  public
  create public .

public section.

  interfaces ZIF_AOT_SERVICE .
  interfaces ZIF_SWAG_HANDLER .

  methods OBJECTS_LIST
    importing
      !IV_PROJECT type ZAOT_PROJECT_NAME
      !IV_RUN_NAME type ZAOT_RUN_NAME
    returning
      value(RT_OBJECTS) type ZAOT_OBJECTS_OVERVIEW_TT .
  methods OBJECT_DETAILS
    importing
      !IV_PROJECT type ZAOT_PROJECT_NAME
      !IV_RUN_NAME type ZAOT_RUN_NAME
      !IV_OBJECT_TYPE type ZAOT_OBJECTS-OBJECT_TYPE
      !IV_OBJECT_NAME type ZAOT_OBJECTS-OBJECT_NAME
    returning
      value(RS_DETAILS) type ZAOT_OBJECT_DETAILS .
  methods RUN_DETAILS
    importing
      !IV_PROJECT type ZAOT_PROJECT_NAME
      !IV_RUN_NAME type ZAOT_RUN_NAME
    returning
      value(RS_DETAILS) type ZAOT_RUNS_DETAILS .
  methods LIST
    importing
      !IV_PACKAGE type DEVCLASS
    returning
      value(RT_CLASSES) type ZCL_AOT_BACKEND=>TY_CLASSES .
  methods RUN
    importing
      !IV_CLASS type SEOCLSNAME
    returning
      value(RS_RESULT) type ZCL_AOT_BACKEND=>TY_TEST_RESULT .
  methods PROJECTS_LIST
    returning
      value(RT_LIST) type ZAOT_PROJECTS_TT .
  methods PROJECT_CREATE
    importing
      !IS_DATA type ZAOT_PROJECT_DATA .
  methods PROJECT_DETAILS
    importing
      !IV_PROJECT type ZAOT_PROJECT_NAME
    returning
      value(RS_DETAILS) type ZAOT_PROJECT_DETAILS .
  methods PROJECT_RUNS
    importing
      !IV_PROJECT type ZAOT_PROJECT_NAME
      !IV_DAYS type INTEGER
    returning
      value(RT_RUNS) type ZAOT_RUNS_OVERVIEW_TT .
protected section.

  constants C_BASE type STRING value '/sap/zabapopentest/rest' ##NO_TEXT.
private section.
ENDCLASS.



CLASS ZCL_AOT_SERVICE_REST IMPLEMENTATION.


  METHOD list.

    rt_classes = zcl_aot_backend=>list_classes( to_upper( iv_package ) ).

  ENDMETHOD.


  METHOD objects_list.

    DATA(lo_run) = zcl_aot_run=>lookup(
      iv_project  = iv_project
      iv_run_name = iv_run_name ).

    LOOP AT lo_run->get_objects( ) INTO DATA(ls_object).
      APPEND INITIAL LINE TO rt_objects ASSIGNING FIELD-SYMBOL(<ls_object>).
      MOVE-CORRESPONDING ls_object TO <ls_object>.

* todo?

    ENDLOOP.

  ENDMETHOD.


  METHOD object_details.

    DATA(lo_run) = zcl_aot_run=>lookup(
      iv_project  = iv_project
      iv_run_name = iv_run_name ).

    READ TABLE lo_run->get_objects( ) WITH KEY
      object_type = iv_object_type
      object_name = iv_object_name
      INTO DATA(ls_object).
    ASSERT sy-subrc = 0.

    MOVE-CORRESPONDING ls_object TO rs_details.

    LOOP AT lo_run->get_blocks( ) INTO DATA(ls_block)
        WHERE prog_class = iv_object_name
        AND class_sub = 'GLOB'
        AND prog_type = iv_object_type.

      APPEND INITIAL LINE TO rs_details-blocks ASSIGNING FIELD-SYMBOL(<ls_block>).
      <ls_block> = CORRESPONDING #( ls_block EXCEPT source ).
      SPLIT ls_block-source AT |\n| INTO TABLE <ls_block>-source.

      LOOP AT lo_run->get_coverage( ) INTO DATA(ls_coverage) WHERE cblock_id = ls_block-cblock_id.

        READ TABLE <ls_block>-coverage WITH KEY
          program_name = ls_coverage-program_name
          class_name = ls_coverage-class_name
          method_name = ls_coverage-method_name
          ASSIGNING FIELD-SYMBOL(<ls_coverage>).
        IF sy-subrc <> 0.
          APPEND INITIAL LINE TO <ls_block>-coverage ASSIGNING <ls_coverage>.
          <ls_coverage>-program_name = ls_coverage-program_name.
          <ls_coverage>-class_name   = ls_coverage-class_name.
          <ls_coverage>-method_name  = ls_coverage-method_name.
        ENDIF.

        APPEND INITIAL LINE TO <ls_coverage>-meta ASSIGNING FIELD-SYMBOL(<ls_meta>).
        <ls_meta>-row   = ls_coverage-rowcov.
        <ls_meta>-col   = ls_coverage-colcov.
        <ls_meta>-color = ls_coverage-colorcov.
        <ls_meta>-icon  = ls_coverage-iconcov.

      ENDLOOP.

    ENDLOOP.

  ENDMETHOD.


  METHOD projects_list.
    rt_list = zcl_aot_project_query=>list( ).
  ENDMETHOD.


  METHOD project_create.

    zcl_aot_project_query=>create( is_data ).

  ENDMETHOD.


  METHOD project_details.

    rs_details = zcl_aot_project=>get_instance( iv_project )->get_details( ).

  ENDMETHOD.


  METHOD project_runs.

* todo, handle IV_DAYS

    DATA(lt_runs) = zcl_aot_project=>get_instance( iv_project )->list_runs( ).

    LOOP AT lt_runs INTO DATA(ls_run).
      APPEND INITIAL LINE TO rt_runs ASSIGNING FIELD-SYMBOL(<ls_run>).
      MOVE-CORRESPONDING ls_run TO <ls_run>.

      DATA(lo_run) = zcl_aot_run=>get_instance( ls_run-run_id ).

      <ls_run>-objects = lines( lo_run->get_objects( ) ).
      <ls_run>-tests_total = lines( lo_run->get_tests( ) ).

      LOOP AT lo_run->get_tests( ) ASSIGNING FIELD-SYMBOL(<ls_test>).
        IF <ls_test>-kind IS INITIAL.
          <ls_run>-tests_passed = <ls_run>-tests_passed + 1.
        ELSE.
          <ls_run>-tests_failed = <ls_run>-tests_failed + 1.
        ENDIF.
      ENDLOOP.
    ENDLOOP.

  ENDMETHOD.


  METHOD run.

    rs_result = zcl_aot_backend=>run_test( iv_class ).

  ENDMETHOD.


  METHOD run_details.

    DATA(lo_run) = zcl_aot_run=>lookup(
      iv_project  = iv_project
      iv_run_name = iv_run_name ).

    rs_details-run     = lo_run->get_details( ).
    rs_details-objects = lo_run->get_objects( ).
    rs_details-tests   = lo_run->get_tests( ).

  ENDMETHOD.


  METHOD zif_aot_service~run.

    DATA: lo_swag TYPE REF TO zcl_swag.


    CREATE OBJECT lo_swag
      EXPORTING
        ii_server = ii_server
        iv_base   = c_base
        iv_title  = 'abapOpenTest'.
    lo_swag->register( me ).

    lo_swag->run( ).

  ENDMETHOD.


  METHOD zif_swag_handler~meta.

    FIELD-SYMBOLS: <ls_meta> LIKE LINE OF rt_meta.

    APPEND INITIAL LINE TO rt_meta ASSIGNING <ls_meta>.
    <ls_meta>-summary   = 'List Classes'(001).
    <ls_meta>-url-regex = '/auto_runner/list$'.
    <ls_meta>-method    = zcl_swag=>c_method-get.
    <ls_meta>-handler   = 'LIST'.
    APPEND 'auto_runner' TO <ls_meta>-tags.

    APPEND INITIAL LINE TO rt_meta ASSIGNING <ls_meta>.
    <ls_meta>-summary   = 'Run Test'(002).
    <ls_meta>-url-regex = '/auto_runner/run$'.
    <ls_meta>-method    = zcl_swag=>c_method-post.
    <ls_meta>-handler   = 'RUN'.
    APPEND 'auto_runner' TO <ls_meta>-tags.

*******************************

    APPEND INITIAL LINE TO rt_meta ASSIGNING <ls_meta>.
    <ls_meta>-summary   = 'List Projects'.
    <ls_meta>-url-regex = '/listProjects$'.
    <ls_meta>-method    = zcl_swag=>c_method-get.
    <ls_meta>-handler   = 'PROJECTS_LIST'.
    APPEND 'projects' TO <ls_meta>-tags.

    APPEND INITIAL LINE TO rt_meta ASSIGNING <ls_meta>.
    <ls_meta>-summary   = 'Create Project'.
    <ls_meta>-url-regex = '/createProject$'.
    <ls_meta>-method    = zcl_swag=>c_method-post.
    <ls_meta>-handler   = 'PROJECT_CREATE'.
    APPEND 'projects' TO <ls_meta>-tags.

    APPEND INITIAL LINE TO rt_meta ASSIGNING <ls_meta>.
    <ls_meta>-summary   = 'Project Details'.
    <ls_meta>-url-regex = '/projects/([\w-]+)$'.
    APPEND 'IV_PROJECT' TO <ls_meta>-url-group_names.
    <ls_meta>-method    = zcl_swag=>c_method-get.
    <ls_meta>-handler   = 'PROJECT_DETAILS'.
    APPEND 'projects' TO <ls_meta>-tags.

    APPEND INITIAL LINE TO rt_meta ASSIGNING <ls_meta>.
    <ls_meta>-summary   = 'Project Runs'.
    <ls_meta>-url-regex = '/projects/([\w-]+)/listRuns$'.
    APPEND 'IV_PROJECT' TO <ls_meta>-url-group_names.
    <ls_meta>-method    = zcl_swag=>c_method-get.
    <ls_meta>-handler   = 'PROJECT_RUNS'.
    APPEND 'projects' TO <ls_meta>-tags.

*******************************

    APPEND INITIAL LINE TO rt_meta ASSIGNING <ls_meta>.
    <ls_meta>-summary   = 'Run Details'.
    <ls_meta>-url-regex = '/projects/([\w-]+)/runs/([\w-]+)$'.
    APPEND 'IV_PROJECT' TO <ls_meta>-url-group_names.
    APPEND 'IV_RUN_NAME' TO <ls_meta>-url-group_names.
    <ls_meta>-method    = zcl_swag=>c_method-get.
    <ls_meta>-handler   = 'RUN_DETAILS'.
    APPEND 'runs' TO <ls_meta>-tags.

    APPEND INITIAL LINE TO rt_meta ASSIGNING <ls_meta>.
    <ls_meta>-summary   = 'List Objects'.
    <ls_meta>-url-regex = '/projects/([\w-]+)/runs/([\w-]+)/objects$'.
    APPEND 'IV_PROJECT' TO <ls_meta>-url-group_names.
    APPEND 'IV_RUN_NAME' TO <ls_meta>-url-group_names.
    <ls_meta>-method    = zcl_swag=>c_method-get.
    <ls_meta>-handler   = 'OBJECTS_LIST'.
    APPEND 'runs' TO <ls_meta>-tags.

    APPEND INITIAL LINE TO rt_meta ASSIGNING <ls_meta>.
    <ls_meta>-summary   = 'List Objects'.
    <ls_meta>-url-regex = '/projects/([\w-]+)/runs/([\w-]+)/objects/([\w-]+)/([\w-]+)$'.
    APPEND 'IV_PROJECT' TO <ls_meta>-url-group_names.
    APPEND 'IV_RUN_NAME' TO <ls_meta>-url-group_names.
    APPEND 'IV_OBJECT_TYPE' TO <ls_meta>-url-group_names.
    APPEND 'IV_OBJECT_NAME' TO <ls_meta>-url-group_names.
    <ls_meta>-method    = zcl_swag=>c_method-get.
    <ls_meta>-handler   = 'OBJECT_DETAILS'.
    APPEND 'runs' TO <ls_meta>-tags.

  ENDMETHOD.
ENDCLASS.
